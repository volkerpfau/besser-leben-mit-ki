<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Challenge üéØ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .challenge-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .login-area {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .user-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.85em;
        }

        .menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .menu-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 40px 20px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .menu-button.admin {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
        }

        .game-area, .admin-area {
            display: none;
        }

        .game-area.active, .admin-area.active {
            display: block;
        }

        .question-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .question-text {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
        }

        .answer-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .word-button {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.2s;
            border: none;
        }

        .word-button:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .word-button.selected {
            background: #48bb78;
        }

        .selected-words {
            min-height: 60px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px dashed #ddd;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #764ba2;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-danger {
            background: #fc8181;
            color: white;
        }

        .btn-danger:hover {
            background: #f56565;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .feedback {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .feedback.correct {
            background: #c6f6d5;
            color: #22543d;
        }

        .feedback.incorrect {
            background: #fed7d7;
            color: #742a2a;
        }

        .highscore {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .highscore h3 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .highscore-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .highscore-entry.me {
            background: #e6f2ff;
            border-left-color: #48bb78;
        }

        .rank {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            width: 40px;
        }

        .rank.gold { color: #ffd700; }
        .rank.silver { color: #c0c0c0; }
        .rank.bronze { color: #cd7f32; }

        .timer {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .hidden {
            display: none !important;
        }

        .admin-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .admin-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .admin-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #667eea;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .file-upload {
            border: 2px dashed #667eea;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload:hover {
            background: #f8f9fa;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .archive-entry {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #ffd700;
        }

        .archive-month {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 8px;
        }
    </style>
    
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body>
    <div class="container">
        <h1>üéØ English Challenge</h1>
        <p class="subtitle">Lerne Englisch mit Spa√ü und Wettbewerb!</p>

        <!-- Challenge Info -->
        <div id="challengeInfo" class="challenge-info hidden">
            üìÖ Aktuelle Challenge: <span id="currentChallenge">Oktober 2025</span>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="loading">
            <p>‚öôÔ∏è Firebase wird initialisiert...</p>
            <p style="font-size: 0.9em; color: #999; margin-top: 10px;">
                Bitte Firebase-Konfiguration eintragen (siehe Anleitung)
            </p>
        </div>

        <!-- Login/Register Area -->
        <div id="authArea" class="login-area hidden">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showLoginTab()">Anmelden</button>
                <button class="tab-button" onclick="showRegisterTab()">Registrieren</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <div id="loginMessage"></div>
                <div class="form-group">
                    <label>Benutzername</label>
                    <input type="text" id="loginUsername" placeholder="Dein Benutzername">
                </div>
                <div class="form-group">
                    <label>Passwort</label>
                    <input type="password" id="loginPassword" placeholder="Dein Passwort">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="login()">Anmelden</button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div id="registerMessage"></div>
                <div class="form-group">
                    <label>Benutzername</label>
                    <input type="text" id="registerUsername" placeholder="W√§hle einen Benutzernamen">
                </div>
                <div class="form-group">
                    <label>Passwort</label>
                    <input type="password" id="registerPassword" placeholder="W√§hle ein Passwort">
                </div>
                <div class="form-group">
                    <label>Passwort wiederholen</label>
                    <input type="password" id="registerPasswordConfirm" placeholder="Passwort best√§tigen">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="register()">Registrieren</button>
            </div>
        </div>

        <!-- Main Game Area -->
        <div id="mainGameArea" class="hidden">
            <!-- User Info -->
            <div class="user-info">
                <div>
                    <div class="user-name">üëã <span id="displayUsername"></span></div>
                    <div style="font-size: 0.9em; color: #666;">Rang: <span id="userRank">-</span></div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="adminBtn" onclick="showAdminPanel()" style="display: none;">‚öôÔ∏è Admin</button>
                    <button class="btn btn-danger" onclick="logout()">Abmelden</button>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="totalScore">0</div>
                    <div class="stat-label">Gesamt</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="gamesPlayed">0</div>
                    <div class="stat-label">Spiele</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="bestScore">0</div>
                    <div class="stat-label">Bestleistung</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="level">1</div>
                    <div class="stat-label">Level</div>
                </div>
            </div>

            <!-- Main Menu -->
            <div id="mainMenu" class="menu">
                <button class="menu-button" onclick="startVocabGame()">
                    üìö Vokabel-Challenge
                </button>
                <button class="menu-button" onclick="startSentenceGame()">
                    ‚úçÔ∏è Satz-Baumeister
                </button>
            </div>

            <!-- Vocabulary Game -->
            <div id="vocabGame" class="game-area">
                <div class="timer" id="vocabTimer">Zeit: 30s</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="vocabProgress" style="width: 0%"></div>
                </div>
                <div class="question-card">
                    <div class="question-text" id="vocabQuestion"></div>
                    <input type="text" class="answer-input" id="vocabAnswer" placeholder="Deine Antwort...">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="checkVocabAnswer()">Antwort pr√ºfen</button>
                    <button class="btn btn-secondary" onclick="skipQuestion()">√úberspringen</button>
                    <button class="btn btn-secondary" onclick="backToMenu()">Zur√ºck</button>
                </div>
                <div id="vocabFeedback"></div>
            </div>

            <!-- Sentence Building Game -->
            <div id="sentenceGame" class="game-area">
                <div class="timer" id="sentenceTimer">Zeit: 45s</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="sentenceProgress" style="width: 0%"></div>
                </div>
                <div class="question-card">
                    <div class="question-text" id="sentenceQuestion"></div>
                    <div class="selected-words" id="selectedWords"></div>
                    <div id="wordButtons"></div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="checkSentence()">Satz pr√ºfen</button>
                    <button class="btn btn-secondary" onclick="clearSentence()">Zur√ºcksetzen</button>
                    <button class="btn btn-secondary" onclick="backToMenu()">Zur√ºck</button>
                </div>
                <div id="sentenceFeedback"></div>
            </div>

            <!-- Global Highscore -->
            <div class="highscore">
                <h3>üèÜ Top 10 Highscores - <span id="currentChallengeMonth"></span></h3>
                <div id="highscoreList">
                    <p style="text-align: center; color: #999;">Lade Highscores...</p>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-area">
            <div class="admin-panel">
                <h2 style="color: #667eea; margin-bottom: 20px;">‚öôÔ∏è Admin Panel</h2>
                
                <!-- Game Settings -->
                <div class="admin-section">
                    <h3>‚öôÔ∏è Spiel-Einstellungen</h3>
                    <p style="color: #666; margin-bottom: 15px;">Passen Sie Schwierigkeit und Dauer der Spiele an</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Vocabulary Challenge Settings -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">üìö Vokabel-Challenge</h4>
                            <div class="form-group">
                                <label>Zeit (Sekunden)</label>
                                <input type="number" id="vocabTime" min="10" max="300" value="30" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                                <small style="color: #666;">Empfohlen: 20-120 Sekunden</small>
                            </div>
                            <div class="form-group">
                                <label>Anzahl Fragen</label>
                                <input type="number" id="vocabQuestions" min="1" max="20" value="5" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                                <small style="color: #666;">Empfohlen: 3-10 Fragen</small>
                            </div>
                        </div>
                        
                        <!-- Sentence Builder Settings -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">‚úçÔ∏è Satz-Baumeister</h4>
                            <div class="form-group">
                                <label>Zeit (Sekunden)</label>
                                <input type="number" id="sentenceTime" min="10" max="300" value="45" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                                <small style="color: #666;">Empfohlen: 30-180 Sekunden</small>
                            </div>
                            <div class="form-group">
                                <label>Anzahl Fragen</label>
                                <input type="number" id="sentenceQuestions" min="1" max="20" value="5" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                                <small style="color: #666;">Empfohlen: 3-10 Fragen</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveGameSettings()">üíæ Einstellungen speichern</button>
                    </div>
                    
                    <div id="settingsMessage" style="margin-top: 15px;"></div>
                </div>

                <!-- Challenge Management -->
                <div class="admin-section">
                    <h3>üìÖ Challenge-Verwaltung</h3>
                    <p style="margin-bottom: 15px;">Aktuelle Challenge: <strong id="adminCurrentChallenge">-</strong></p>
                    <div class="action-buttons">
                        <button class="btn btn-danger" onclick="resetChallenge()">üîÑ Neue Challenge starten</button>
                        <button class="btn btn-secondary" onclick="viewChallengeArchive()">üìö Archiv anzeigen</button>
                    </div>
                    <div id="archiveDisplay" class="hidden" style="margin-top: 20px;"></div>
                </div>

                <!-- Vocabulary Management -->
                <div class="admin-section">
                    <h3>üìù Vokabel-Verwaltung</h3>
                    
                    <!-- File Upload Options -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <!-- CSV Upload -->
                        <div class="file-upload" onclick="document.getElementById('csvFile').click()">
                            <input type="file" id="csvFile" accept=".csv" onchange="uploadCSV(event)">
                            <p>üì§ CSV hochladen</p>
                            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                                Format: Deutsch,Englisch,Kategorie
                            </p>
                        </div>
                        
                        <!-- PDF Upload -->
                        <div class="file-upload" onclick="document.getElementById('pdfFile').click()">
                            <input type="file" id="pdfFile" accept=".pdf" onchange="uploadPDF(event)">
                            <p>üìÑ PDF hochladen</p>
                            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                                Vokabelliste aus Schulbuch
                            </p>
                        </div>
                    </div>
                    
                    <!-- PDF Preview Area -->
                    <div id="pdfPreview" class="hidden" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">üìã Erkannte Vokabeln aus PDF</h4>
                        <div class="form-group">
                            <label>Kategorie f√ºr alle Vokabeln</label>
                            <input type="text" id="pdfCategory" placeholder="z.B. Unit 3, Kapitel 5, etc.">
                        </div>
                        <div id="pdfVocabList" style="max-height: 400px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="savePDFVocabulary()">‚úÖ Vokabeln √ºbernehmen</button>
                            <button class="btn btn-secondary" onclick="cancelPDFUpload()">Abbrechen</button>
                        </div>
                    </div>

                    <!-- Add Vocabulary Form -->
                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 10px;">Einzelne Vokabel hinzuf√ºgen:</h4>
                        <div class="form-group">
                            <label>Deutsch</label>
                            <input type="text" id="vocabGerman" placeholder="z.B. das Haus">
                        </div>
                        <div class="form-group">
                            <label>Englisch</label>
                            <input type="text" id="vocabEnglish" placeholder="z.B. house">
                        </div>
                        <div class="form-group">
                            <label>Kategorie</label>
                            <input type="text" id="vocabCategory" placeholder="z.B. Basics">
                        </div>
                        <button class="btn btn-success" onclick="addVocabulary()">‚ûï Vokabel hinzuf√ºgen</button>
                    </div>

                    <!-- Vocabulary List -->
                    <div style="margin-top: 20px;">
                        <h4>Vorhandene Vokabeln (<span id="vocabCount">0</span>):</h4>
                        <div id="vocabList" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Sentence Management -->
                <div class="admin-section">
                    <h3>‚úçÔ∏è Satz-Verwaltung</h3>
                    
                    <!-- Add Sentence Form -->
                    <div class="form-group">
                        <label>Deutscher Satz</label>
                        <input type="text" id="sentenceGerman" placeholder="z.B. Ich gehe in die Schule">
                    </div>
                    <div class="form-group">
                        <label>Englische W√∂rter (kommagetrennt)</label>
                        <input type="text" id="sentenceEnglish" placeholder="z.B. I,go,to,school">
                    </div>
                    <button class="btn btn-success" onclick="addSentence()">‚ûï Satz hinzuf√ºgen</button>

                    <!-- Sentence List -->
                    <div style="margin-top: 20px;">
                        <h4>Vorhandene S√§tze (<span id="sentenceCount">0</span>):</h4>
                        <div id="sentenceList" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- User Statistics -->
                <div class="admin-section">
                    <h3>üë• Benutzer-Statistiken</h3>
                    <div id="userStats"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="hideAdminPanel()">Zur√ºck zum Spiel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, update, onValue, query, orderByChild, limitToLast, remove, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // TODO: HIER DEINE FIREBASE-KONFIGURATION EINF√úGEN!
        const firebaseConfig = {
¬† apiKey: "AIzaSyBee3T19i5i4cVwtTpakNVoyYN7Cod4dq4",
¬† authDomain: "english-challenge-first.firebaseapp.com",
¬† databaseURL: "https://english-challenge-first-default-rtdb.europe-west1.firebasedatabase.app",
¬† projectId: "english-challenge-first",
¬† storageBucket: "english-challenge-first.firebasestorage.app",
¬† messagingSenderId: "476785689417",
¬† appId: "1:476785689417:web:10b25aaf4489ab3e971098",
¬† measurementId: "G-8WX2J9LXEE"
};

        let app, database;

        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            console.log("Firebase erfolgreich initialisiert!");
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('authArea').classList.remove('hidden');
            
            // Initialize default admin if not exists
            initializeDefaultData();
        } catch (error) {
            console.error("Firebase Fehler:", error);
            document.getElementById('loadingScreen').innerHTML = 
                '<p style="color: #e53e3e;">‚ö†Ô∏è Firebase-Konfiguration fehlt oder ist falsch!</p>' +
                '<p style="font-size: 0.9em; margin-top: 10px;">Bitte die Firebase-Einstellungen im Code eintragen.</p>';
        }

        async function initializeDefaultData() {
            // Check if admin exists
            const adminRef = ref(database, 'users/admin');
            const adminSnapshot = await get(adminRef);
            
            if (!adminSnapshot.exists()) {
                await set(adminRef, {
                    username: 'admin',
                    password: 'admin123',
                    isAdmin: true,
                    totalScore: 0,
                    gamesPlayed: 0,
                    bestScore: 0,
                    level: 1,
                    created: new Date().toISOString()
                });
            }

            // Initialize current challenge if not exists
            const challengeRef = ref(database, 'challenge/current');
            const challengeSnapshot = await get(challengeRef);
            
            if (!challengeSnapshot.exists()) {
                const now = new Date();
                const monthYear = now.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                await set(challengeRef, {
                    name: monthYear,
                    startDate: now.toISOString(),
                    active: true
                });
            }

            // Initialize game settings if not exists
            const settingsRef = ref(database, 'settings/game');
            const settingsSnapshot = await get(settingsRef);
            
            if (!settingsSnapshot.exists()) {
                await set(settingsRef, {
                    vocabTime: 30,
                    vocabQuestions: 5,
                    sentenceTime: 45,
                    sentenceQuestions: 5
                });
            }
        }

        // Make Firebase functions available globally
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseUpdate = update;
        window.firebaseOnValue = onValue;
        window.firebaseQuery = query;
        window.firebaseOrderByChild = orderByChild;
        window.firebaseLimitToLast = limitToLast;
        window.firebaseRemove = remove;
        window.firebasePush = push;
    </script>

    <script>
        // Game State
        let gameState = {
            currentScore: 0,
            currentStreak: 0,
            currentQuestion: 0,
            totalQuestions: 5,
            timer: null,
            timeLeft: 0
        };

        let gameSettings = {
            vocabTime: 30,
            vocabQuestions: 5,
            sentenceTime: 45,
            sentenceQuestions: 5
        };

        let userData = {
            username: '',
            isAdmin: false,
            totalScore: 0,
            gamesPlayed: 0,
            bestScore: 0,
            level: 1
        };

        let currentChallenge = '';
        let vocabularyDB = [];
        let sentencesDB = [];
        let currentVocab = null;
        let currentSentence = null;
        let selectedWordsArray = [];

        // Auth Functions
        function showLoginTab() {
            document.querySelectorAll('.tab-button')[0].classList.add('active');
            document.querySelectorAll('.tab-button')[1].classList.remove('active');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegisterTab() {
            document.querySelectorAll('.tab-button')[1].classList.add('active');
            document.querySelectorAll('.tab-button')[0].classList.remove('active');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
        }

        async function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const messageDiv = document.getElementById('registerMessage');

            if (!username || !password) {
                messageDiv.innerHTML = '<div class="error-message">Bitte alle Felder ausf√ºllen!</div>';
                return;
            }

            if (password !== passwordConfirm) {
                messageDiv.innerHTML = '<div class="error-message">Passw√∂rter stimmen nicht √ºberein!</div>';
                return;
            }

            if (password.length < 4) {
                messageDiv.innerHTML = '<div class="error-message">Passwort muss mindestens 4 Zeichen lang sein!</div>';
                return;
            }

            try {
                const userRef = window.firebaseRef(window.firebaseDB, 'users/' + username);
                const snapshot = await window.firebaseGet(userRef);

                if (snapshot.exists()) {
                    messageDiv.innerHTML = '<div class="error-message">Benutzername bereits vergeben!</div>';
                    return;
                }

                await window.firebaseSet(userRef, {
                    username: username,
                    password: password,
                    isAdmin: false,
                    totalScore: 0,
                    gamesPlayed: 0,
                    bestScore: 0,
                    level: 1,
                    created: new Date().toISOString()
                });

                messageDiv.innerHTML = '<div class="success-message">‚úÖ Registrierung erfolgreich! Du kannst dich jetzt anmelden.</div>';
                
                setTimeout(() => {
                    document.getElementById('loginUsername').value = username;
                    showLoginTab();
                }, 1500);

            } catch (error) {
                console.error('Register error:', error);
                messageDiv.innerHTML = '<div class="error-message">Fehler bei der Registrierung!</div>';
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const messageDiv = document.getElementById('loginMessage');

            if (!username || !password) {
                messageDiv.innerHTML = '<div class="error-message">Bitte beide Felder ausf√ºllen!</div>';
                return;
            }

            try {
                const userRef = window.firebaseRef(window.firebaseDB, 'users/' + username);
                const snapshot = await window.firebaseGet(userRef);

                if (!snapshot.exists()) {
                    messageDiv.innerHTML = '<div class="error-message">Benutzername nicht gefunden!</div>';
                    return;
                }

                const user = snapshot.val();
                if (user.password !== password) {
                    messageDiv.innerHTML = '<div class="error-message">Falsches Passwort!</div>';
                    return;
                }

                userData = user;
                userData.username = username;
                
                document.getElementById('authArea').classList.add('hidden');
                document.getElementById('mainGameArea').classList.remove('hidden');
                document.getElementById('challengeInfo').classList.remove('hidden');
                
                if (userData.isAdmin) {
                    document.getElementById('adminBtn').style.display = 'block';
                }
                
                await loadCurrentChallenge();
                await loadVocabulary();
                await loadSentences();
                await loadGameSettings();
                updateUserDisplay();
                loadHighscores();

            } catch (error) {
                console.error('Login error:', error);
                messageDiv.innerHTML = '<div class="error-message">Fehler beim Anmelden!</div>';
            }
        }

        function logout() {
            if (confirm('M√∂chtest du dich wirklich abmelden?')) {
                userData = {
                    username: '',
                    isAdmin: false,
                    totalScore: 0,
                    gamesPlayed: 0,
                    bestScore: 0,
                    level: 1
                };
                
                document.getElementById('mainGameArea').classList.add('hidden');
                document.getElementById('challengeInfo').classList.add('hidden');
                document.getElementById('authArea').classList.remove('hidden');
                document.getElementById('adminPanel').classList.remove('active');
                document.getElementById('loginPassword').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerPasswordConfirm').value = '';
            }
        }

        async function loadCurrentChallenge() {
            try {
                const challengeRef = window.firebaseRef(window.firebaseDB, 'challenge/current');
                const snapshot = await window.firebaseGet(challengeRef);
                
                if (snapshot.exists()) {
                    const challenge = snapshot.val();
                    currentChallenge = challenge.name;
                    document.getElementById('currentChallenge').textContent = currentChallenge;
                    document.getElementById('currentChallengeMonth').textContent = currentChallenge;
                    if (userData.isAdmin) {
                        document.getElementById('adminCurrentChallenge').textContent = currentChallenge;
                    }
                }
            } catch (error) {
                console.error('Error loading challenge:', error);
            }
        }

        async function loadVocabulary() {
            try {
                const vocabRef = window.firebaseRef(window.firebaseDB, 'vocabulary');
                const snapshot = await window.firebaseGet(vocabRef);
                
                if (snapshot.exists()) {
                    const vocabData = snapshot.val();
                    vocabularyDB = Object.entries(vocabData).map(([key, value]) => ({
                        id: key,
                        ...value
                    }));
                } else {
                    // Initialize with default vocabulary
                    vocabularyDB = [
                        { german: "das Haus", english: "house", category: "Basics" },
                        { german: "die Schule", english: "school", category: "Basics" },
                        { german: "der Freund", english: "friend", category: "People" },
                        { german: "die Familie", english: "family", category: "People" },
                        { german: "das Buch", english: "book", category: "School" }
                    ];
                    
                    for (const vocab of vocabularyDB) {
                        await window.firebasePush(vocabRef, vocab);
                    }
                    await loadVocabulary();
                }
            } catch (error) {
                console.error('Error loading vocabulary:', error);
            }
        }

        async function loadSentences() {
            try {
                const sentenceRef = window.firebaseRef(window.firebaseDB, 'sentences');
                const snapshot = await window.firebaseGet(sentenceRef);
                
                if (snapshot.exists()) {
                    const sentenceData = snapshot.val();
                    sentencesDB = Object.entries(sentenceData).map(([key, value]) => ({
                        id: key,
                        ...value
                    }));
                } else {
                    // Initialize with default sentences
                    sentencesDB = [
                        {
                            german: "Ich gehe in die Schule.",
                            words: ["I", "go", "to", "school"],
                            correct: ["I", "go", "to", "school"]
                        },
                        {
                            german: "Sie spielt mit ihrem Hund.",
                            words: ["She", "plays", "with", "her", "dog"],
                            correct: ["She", "plays", "with", "her", "dog"]
                        }
                    ];
                    
                    for (const sentence of sentencesDB) {
                        await window.firebasePush(sentenceRef, sentence);
                    }
                    await loadSentences();
                }
            } catch (error) {
                console.error('Error loading sentences:', error);
            }
        }

        async function loadGameSettings() {
            try {
                const settingsRef = window.firebaseRef(window.firebaseDB, 'settings/game');
                const snapshot = await window.firebaseGet(settingsRef);
                
                if (snapshot.exists()) {
                    gameSettings = snapshot.val();
                    
                    // Update admin panel inputs if in admin mode
                    if (userData.isAdmin) {
                        document.getElementById('vocabTime').value = gameSettings.vocabTime;
                        document.getElementById('vocabQuestions').value = gameSettings.vocabQuestions;
                        document.getElementById('sentenceTime').value = gameSettings.sentenceTime;
                        document.getElementById('sentenceQuestions').value = gameSettings.sentenceQuestions;
                    }
                } else {
                    // Use defaults
                    gameSettings = {
                        vocabTime: 30,
                        vocabQuestions: 5,
                        sentenceTime: 45,
                        sentenceQuestions: 5
                    };
                }
            } catch (error) {
                console.error('Error loading game settings:', error);
            }
        }

        function updateUserDisplay() {
            document.getElementById('displayUsername').textContent = userData.username;
            document.getElementById('totalScore').textContent = userData.totalScore;
            document.getElementById('gamesPlayed').textContent = userData.gamesPlayed;
            document.getElementById('bestScore').textContent = userData.bestScore;
            document.getElementById('level').textContent = userData.level;
        }

        async function saveUserProgress() {
            try {
                const userRef = window.firebaseRef(window.firebaseDB, 'users/' + userData.username);
                await window.firebaseUpdate(userRef, {
                    totalScore: userData.totalScore,
                    gamesPlayed: userData.gamesPlayed,
                    bestScore: userData.bestScore,
                    level: userData.level,
                    lastPlayed: new Date().toISOString()
                });
                updateUserDisplay();
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }

        async function loadHighscores() {
            try {
                const usersRef = window.firebaseRef(window.firebaseDB, 'users');
                const snapshot = await window.firebaseGet(usersRef);
                
                if (!snapshot.exists()) {
                    document.getElementById('highscoreList').innerHTML = 
                        '<p style="text-align: center; color: #999;">Noch keine Highscores</p>';
                    return;
                }

                const users = snapshot.val();
                const userArray = Object.values(users).filter(u => !u.isAdmin);
                
                userArray.sort((a, b) => b.totalScore - a.totalScore);
                const top10 = userArray.slice(0, 10);
                
                let html = '';
                let myRank = 0;
                
                top10.forEach((user, index) => {
                    const rank = index + 1;
                    let rankIcon = rank;
                    let rankClass = '';
                    
                    if (rank === 1) { rankIcon = 'ü•á'; rankClass = 'gold'; }
                    else if (rank === 2) { rankIcon = 'ü•à'; rankClass = 'silver'; }
                    else if (rank === 3) { rankIcon = 'ü•â'; rankClass = 'bronze'; }
                    
                    const isMe = user.username === userData.username;
                    if (isMe) myRank = rank;
                    
                    html += `
                        <div class="highscore-entry ${isMe ? 'me' : ''}">
                            <span class="rank ${rankClass}">${rankIcon}</span>
                            <span style="flex: 1; font-weight: bold;">${user.username}${isMe ? ' (Du)' : ''}</span>
                            <span style="color: #667eea; font-weight: bold;">${user.totalScore} Pkt.</span>
                            <span style="color: #999; font-size: 0.9em; margin-left: 10px;">Level ${user.level}</span>
                        </div>
                    `;
                });
                
                document.getElementById('highscoreList').innerHTML = html;
                document.getElementById('userRank').textContent = myRank > 0 ? '#' + myRank : 'Nicht in Top 10';
                
            } catch (error) {
                console.error('Error loading highscores:', error);
            }
        }

        // Admin Functions
        function showAdminPanel() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('adminPanel').classList.add('active');
            loadAdminData();
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').classList.remove('active');
            document.getElementById('mainMenu').style.display = 'grid';
        }

        async function loadAdminData() {
            await loadVocabularyList();
            await loadSentenceList();
            await loadUserStats();
            await loadGameSettings();
        }

        async function loadVocabularyList() {
            document.getElementById('vocabCount').textContent = vocabularyDB.length;
            
            let html = '<table class="data-table"><thead><tr><th>Deutsch</th><th>Englisch</th><th>Kategorie</th><th>Aktion</th></tr></thead><tbody>';
            
            vocabularyDB.forEach(vocab => {
                html += `
                    <tr>
                        <td>${vocab.german}</td>
                        <td>${vocab.english}</td>
                        <td>${vocab.category}</td>
                        <td><button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9em;" onclick="deleteVocab('${vocab.id}')">L√∂schen</button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('vocabList').innerHTML = html;
        }

        async function loadSentenceList() {
            document.getElementById('sentenceCount').textContent = sentencesDB.length;
            
            let html = '<table class="data-table"><thead><tr><th>Deutsch</th><th>Englisch</th><th>Aktion</th></tr></thead><tbody>';
            
            sentencesDB.forEach(sentence => {
                html += `
                    <tr>
                        <td>${sentence.german}</td>
                        <td>${sentence.correct.join(' ')}</td>
                        <td><button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9em;" onclick="deleteSentence('${sentence.id}')">L√∂schen</button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('sentenceList').innerHTML = html;
        }

        async function loadUserStats() {
            try {
                const usersRef = window.firebaseRef(window.firebaseDB, 'users');
                const snapshot = await window.firebaseGet(usersRef);
                
                if (!snapshot.exists()) {
                    document.getElementById('userStats').innerHTML = '<p>Keine Benutzer gefunden.</p>';
                    return;
                }

                const users = snapshot.val();
                const userArray = Object.values(users).filter(u => !u.isAdmin);
                
                let html = `<p>Gesamt registrierte Sch√ºler: <strong>${userArray.length}</strong></p>`;
                html += '<table class="data-table"><thead><tr><th>Benutzername</th><th>Punkte</th><th>Spiele</th><th>Beste</th><th>Level</th></tr></thead><tbody>';
                
                userArray.forEach(user => {
                    html += `
                        <tr>
                            <td>${user.username}</td>
                            <td>${user.totalScore}</td>
                            <td>${user.gamesPlayed}</td>
                            <td>${user.bestScore}</td>
                            <td>${user.level}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                document.getElementById('userStats').innerHTML = html;
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        async function addVocabulary() {
            const german = document.getElementById('vocabGerman').value.trim();
            const english = document.getElementById('vocabEnglish').value.trim();
            const category = document.getElementById('vocabCategory').value.trim();

            if (!german || !english || !category) {
                alert('Bitte alle Felder ausf√ºllen!');
                return;
            }

            try {
                const vocabRef = window.firebaseRef(window.firebaseDB, 'vocabulary');
                await window.firebasePush(vocabRef, { german, english, category });
                
                document.getElementById('vocabGerman').value = '';
                document.getElementById('vocabEnglish').value = '';
                document.getElementById('vocabCategory').value = '';
                
                await loadVocabulary();
                await loadVocabularyList();
                alert('‚úÖ Vokabel erfolgreich hinzugef√ºgt!');
            } catch (error) {
                console.error('Error adding vocabulary:', error);
                alert('‚ùå Fehler beim Hinzuf√ºgen!');
            }
        }

        async function deleteVocab(id) {
            if (!confirm('Vokabel wirklich l√∂schen?')) return;

            try {
                const vocabRef = window.firebaseRef(window.firebaseDB, 'vocabulary/' + id);
                await window.firebaseRemove(vocabRef);
                await loadVocabulary();
                await loadVocabularyList();
                alert('‚úÖ Vokabel gel√∂scht!');
            } catch (error) {
                console.error('Error deleting vocabulary:', error);
                alert('‚ùå Fehler beim L√∂schen!');
            }
        }

        async function addSentence() {
            const german = document.getElementById('sentenceGerman').value.trim();
            const englishWords = document.getElementById('sentenceEnglish').value.trim();

            if (!german || !englishWords) {
                alert('Bitte beide Felder ausf√ºllen!');
                return;
            }

            const words = englishWords.split(',').map(w => w.trim());

            try {
                const sentenceRef = window.firebaseRef(window.firebaseDB, 'sentences');
                await window.firebasePush(sentenceRef, {
                    german,
                    words,
                    correct: words
                });
                
                document.getElementById('sentenceGerman').value = '';
                document.getElementById('sentenceEnglish').value = '';
                
                await loadSentences();
                await loadSentenceList();
                alert('‚úÖ Satz erfolgreich hinzugef√ºgt!');
            } catch (error) {
                console.error('Error adding sentence:', error);
                alert('‚ùå Fehler beim Hinzuf√ºgen!');
            }
        }

        async function deleteSentence(id) {
            if (!confirm('Satz wirklich l√∂schen?')) return;

            try {
                const sentenceRef = window.firebaseRef(window.firebaseDB, 'sentences/' + id);
                await window.firebaseRemove(sentenceRef);
                await loadSentences();
                await loadSentenceList();
                alert('‚úÖ Satz gel√∂scht!');
            } catch (error) {
                console.error('Error deleting sentence:', error);
                alert('‚ùå Fehler beim L√∂schen!');
            }
        }

        async function uploadCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                
                let added = 0;
                const vocabRef = window.firebaseRef(window.firebaseDB, 'vocabulary');

                for (const line of lines) {
                    const parts = line.split(',').map(p => p.trim());
                    if (parts.length >= 3 && parts[0] && parts[1]) {
                        try {
                            await window.firebasePush(vocabRef, {
                                german: parts[0],
                                english: parts[1],
                                category: parts[2] || 'Allgemein'
                            });
                            added++;
                        } catch (error) {
                            console.error('Error adding vocab from CSV:', error);
                        }
                    }
                }

                await loadVocabulary();
                await loadVocabularyList();
                alert(`‚úÖ ${added} Vokabeln aus CSV importiert!`);
            };

            reader.readAsText(file);
        }

        let extractedVocabulary = [];

        async function uploadPDF(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = '';
                
                // Extract text from all pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }

                // Parse vocabulary from text
                extractedVocabulary = parseVocabularyFromText(fullText);

                if (extractedVocabulary.length === 0) {
                    alert('‚ö†Ô∏è Keine Vokabeln im erwarteten Format gefunden.\n\nErwartetes Format:\n- "Deutsch - Englisch"\n- "Deutsch: Englisch"\n- "Deutsch = Englisch"');
                    return;
                }

                // Show preview
                displayPDFPreview();

            } catch (error) {
                console.error('Error processing PDF:', error);
                alert('‚ùå Fehler beim Verarbeiten der PDF-Datei!');
            }
        }

        function parseVocabularyFromText(text) {
            const vocabulary = [];
            const lines = text.split('\n');
            
            // Pattern 1: "word - translation" or "word ‚Äì translation"
            const pattern1 = /([^-‚Äì:=]+)\s*[-‚Äì:=]\s*([^-‚Äì:=\n]+)/g;
            
            for (const line of lines) {
                // Skip very short lines or lines with numbers only
                if (line.trim().length < 5 || /^\d+\s*$/.test(line.trim())) {
                    continue;
                }

                // Try to find vocabulary pairs
                const matches = line.matchAll(pattern1);
                
                for (const match of matches) {
                    let german = match[1].trim();
                    let english = match[2].trim();
                    
                    // Clean up common artifacts
                    german = german.replace(/^\d+\.?\s*/, ''); // Remove leading numbers
                    english = english.replace(/^\d+\.?\s*/, '');
                    german = german.replace(/\s+/g, ' '); // Normalize spaces
                    english = english.replace(/\s+/g, ' ');
                    
                    // Basic validation
                    if (german.length > 2 && english.length > 2 && 
                        german.length < 100 && english.length < 100 &&
                        !german.match(/^\d+$/) && !english.match(/^\d+$/)) {
                        
                        // Check if it looks like a reasonable vocabulary entry
                        // German words often have articles (der, die, das) or special characters
                        const looksLikeGerman = /^(der|die|das|ein|eine)\s|√§|√∂|√º|√ü/i.test(german);
                        const hasLetters = /[a-zA-Z]/.test(german) && /[a-zA-Z]/.test(english);
                        
                        if (hasLetters && (looksLikeGerman || german.length > 4)) {
                            vocabulary.push({
                                german: german,
                                english: english,
                                category: ''
                            });
                        }
                    }
                }
            }

            // Remove duplicates
            const unique = [];
            const seen = new Set();
            
            for (const vocab of vocabulary) {
                const key = vocab.german.toLowerCase() + '|' + vocab.english.toLowerCase();
                if (!seen.has(key)) {
                    seen.add(key);
                    unique.push(vocab);
                }
            }

            return unique;
        }

        function displayPDFPreview() {
            document.getElementById('pdfPreview').classList.remove('hidden');
            
            let html = `<p style="color: #48bb78; font-weight: bold; margin-bottom: 15px;">‚úÖ ${extractedVocabulary.length} Vokabeln gefunden!</p>`;
            html += '<table class="data-table"><thead><tr><th style="width: 45%">Deutsch</th><th style="width: 45%">Englisch</th><th style="width: 10%">Aktion</th></tr></thead><tbody>';
            
            extractedVocabulary.forEach((vocab, index) => {
                html += `
                    <tr id="pdfVocab_${index}">
                        <td><input type="text" value="${vocab.german}" id="pdfGerman_${index}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;"></td>
                        <td><input type="text" value="${vocab.english}" id="pdfEnglish_${index}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;"></td>
                        <td><button onclick="removePDFVocab(${index})" style="padding: 5px 10px; background: #fc8181; color: white; border: none; border-radius: 4px; cursor: pointer;">‚úï</button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('pdfVocabList').innerHTML = html;
            
            // Scroll to preview
            document.getElementById('pdfPreview').scrollIntoView({ behavior: 'smooth' });
        }

        function removePDFVocab(index) {
            document.getElementById(`pdfVocab_${index}`).remove();
        }

        async function savePDFVocabulary() {
            const category = document.getElementById('pdfCategory').value.trim() || 'Allgemein';
            
            if (!category) {
                alert('Bitte eine Kategorie eingeben!');
                return;
            }

            let saved = 0;
            const vocabRef = window.firebaseRef(window.firebaseDB, 'vocabulary');

            // Get updated values from input fields
            for (let i = 0; i < extractedVocabulary.length; i++) {
                const germanInput = document.getElementById(`pdfGerman_${i}`);
                const englishInput = document.getElementById(`pdfEnglish_${i}`);
                
                if (germanInput && englishInput) {
                    const german = germanInput.value.trim();
                    const english = englishInput.value.trim();
                    
                    if (german && english) {
                        try {
                            await window.firebasePush(vocabRef, {
                                german: german,
                                english: english,
                                category: category
                            });
                            saved++;
                        } catch (error) {
                            console.error('Error saving vocabulary:', error);
                        }
                    }
                }
            }

            await loadVocabulary();
            await loadVocabularyList();
            
            document.getElementById('pdfPreview').classList.add('hidden');
            document.getElementById('pdfCategory').value = '';
            document.getElementById('pdfFile').value = '';
            extractedVocabulary = [];
            
            alert(`‚úÖ ${saved} Vokabeln aus PDF √ºbernommen!`);
        }

        function cancelPDFUpload() {
            document.getElementById('pdfPreview').classList.add('hidden');
            document.getElementById('pdfCategory').value = '';
            document.getElementById('pdfFile').value = '';
            extractedVocabulary = [];
        }

        async function resetChallenge() {
            if (!confirm('‚ö†Ô∏è ACHTUNG!\n\nDies startet eine neue Challenge und archiviert die aktuellen Highscores.\nAlle Spieler-Punkte werden auf 0 zur√ºckgesetzt.\n\nWirklich fortfahren?')) {
                return;
            }

            try {
                // Archive current challenge
                const usersRef = window.firebaseRef(window.firebaseDB, 'users');
                const usersSnapshot = await window.firebaseGet(usersRef);
                
                if (usersSnapshot.exists()) {
                    const users = usersSnapshot.val();
                    const archiveRef = window.firebaseRef(window.firebaseDB, 'archive/' + currentChallenge.replace(/\s+/g, '_'));
                    
                    const archiveData = {};
                    Object.entries(users).forEach(([key, user]) => {
                        if (!user.isAdmin) {
                            archiveData[key] = {
                                username: user.username,
                                totalScore: user.totalScore,
                                bestScore: user.bestScore,
                                gamesPlayed: user.gamesPlayed,
                                level: user.level
                            };
                        }
                    });
                    
                    await window.firebaseSet(archiveRef, archiveData);
                }

                // Reset all user scores
                const userList = Object.keys(usersSnapshot.val());
                for (const username of userList) {
                    if (username !== 'admin') {
                        const userRef = window.firebaseRef(window.firebaseDB, 'users/' + username);
                        await window.firebaseUpdate(userRef, {
                            totalScore: 0,
                            gamesPlayed: 0,
                            bestScore: 0,
                            level: 1
                        });
                    }
                }

                // Create new challenge
                const now = new Date();
                const monthYear = now.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                const challengeRef = window.firebaseRef(window.firebaseDB, 'challenge/current');
                await window.firebaseSet(challengeRef, {
                    name: monthYear,
                    startDate: now.toISOString(),
                    active: true
                });

                alert('‚úÖ Neue Challenge erfolgreich gestartet!\n\nAlle Punkte wurden zur√ºckgesetzt.');
                location.reload();

            } catch (error) {
                console.error('Error resetting challenge:', error);
                alert('‚ùå Fehler beim Zur√ºcksetzen!');
            }
        }

        async function viewChallengeArchive() {
            try {
                const archiveRef = window.firebaseRef(window.firebaseDB, 'archive');
                const snapshot = await window.firebaseGet(archiveRef);
                
                const archiveDiv = document.getElementById('archiveDisplay');
                
                if (!snapshot.exists()) {
                    archiveDiv.innerHTML = '<p style="text-align: center; color: #999; margin-top: 15px;">Noch keine archivierten Challenges</p>';
                    archiveDiv.classList.remove('hidden');
                    return;
                }

                const archives = snapshot.val();
                let html = '<h4 style="margin-top: 15px; margin-bottom: 10px;">üìö Challenge-Archiv</h4>';
                
                Object.entries(archives).forEach(([month, users]) => {
                    const monthName = month.replace(/_/g, ' ');
                    const userArray = Object.values(users);
                    userArray.sort((a, b) => b.totalScore - a.totalScore);
                    const winner = userArray[0];
                    
                    html += `
                        <div class="archive-entry">
                            <div class="archive-month">üèÜ ${monthName}</div>
                            <div style="font-size: 0.95em; color: #666;">
                                Sieger: <strong>${winner.username}</strong> mit ${winner.totalScore} Punkten
                            </div>
                        </div>
                    `;
                });
                
                archiveDiv.innerHTML = html;
                archiveDiv.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading archive:', error);
            }
        }

        async function saveGameSettings() {
            const vocabTime = parseInt(document.getElementById('vocabTime').value);
            const vocabQuestions = parseInt(document.getElementById('vocabQuestions').value);
            const sentenceTime = parseInt(document.getElementById('sentenceTime').value);
            const sentenceQuestions = parseInt(document.getElementById('sentenceQuestions').value);
            
            // Validation
            if (vocabTime < 10 || vocabTime > 300) {
                document.getElementById('settingsMessage').innerHTML = 
                    '<div class="error-message">Vokabel-Zeit muss zwischen 10 und 300 Sekunden liegen!</div>';
                return;
            }
            
            if (sentenceTime < 10 || sentenceTime > 300) {
                document.getElementById('settingsMessage').innerHTML = 
                    '<div class="error-message">Satz-Zeit muss zwischen 10 und 300 Sekunden liegen!</div>';
                return;
            }
            
            if (vocabQuestions < 1 || vocabQuestions > 20) {
                document.getElementById('settingsMessage').innerHTML = 
                    '<div class="error-message">Anzahl Vokabel-Fragen muss zwischen 1 und 20 liegen!</div>';
                return;
            }
            
            if (sentenceQuestions < 1 || sentenceQuestions > 20) {
                document.getElementById('settingsMessage').innerHTML = 
                    '<div class="error-message">Anzahl Satz-Fragen muss zwischen 1 und 20 liegen!</div>';
                return;
            }
            
            try {
                const settingsRef = window.firebaseRef(window.firebaseDB, 'settings/game');
                await window.firebaseSet(settingsRef, {
                    vocabTime: vocabTime,
                    vocabQuestions: vocabQuestions,
                    sentenceTime: sentenceTime,
                    sentenceQuestions: sentenceQuestions
                });
                
                // Update local settings
                gameSettings = {
                    vocabTime: vocabTime,
                    vocabQuestions: vocabQuestions,
                    sentenceTime: sentenceTime,
                    sentenceQuestions: sentenceQuestions
                };
                
                document.getElementById('settingsMessage').innerHTML = 
                    '<div class="success-message">‚úÖ Einstellungen erfolgreich gespeichert! Die neuen Einstellungen gelten ab sofort f√ºr alle Spieler.</div>';
                
                setTimeout(() => {
                    document.getElementById('settingsMessage').innerHTML = '';
                }, 3000);
                
            } catch (error) {
                console.error('Error saving settings:', error);
                document.getElementById('settingsMessage').innerHTML = 
                    '<div class="error-message">‚ùå Fehler beim Speichern der Einstellungen!</div>';
            }
        }

        // Game Functions
        function startVocabGame() {
            if (vocabularyDB.length === 0) {
                alert('‚ö†Ô∏è Keine Vokabeln vorhanden! Bitte Admin kontaktieren.');
                return;
            }

            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('vocabGame').classList.add('active');
            gameState.currentQuestion = 0;
            gameState.currentScore = 0;
            gameState.currentStreak = 0;
            gameState.totalQuestions = gameSettings.vocabQuestions;
            gameState.timeLeft = gameSettings.vocabTime;
            nextVocabQuestion();
            startTimer('vocab');
        }

        function startSentenceGame() {
            if (sentencesDB.length === 0) {
                alert('‚ö†Ô∏è Keine S√§tze vorhanden! Bitte Admin kontaktieren.');
                return;
            }

            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('sentenceGame').classList.add('active');
            gameState.currentQuestion = 0;
            gameState.currentScore = 0;
            gameState.currentStreak = 0;
            gameState.totalQuestions = gameSettings.sentenceQuestions;
            gameState.timeLeft = gameSettings.sentenceTime;
            nextSentenceQuestion();
            startTimer('sentence');
        }

        function nextVocabQuestion() {
            if (gameState.currentQuestion >= gameState.totalQuestions) {
                endGame('vocab');
                return;
            }

            currentVocab = vocabularyDB[Math.floor(Math.random() * vocabularyDB.length)];
            const direction = Math.random() > 0.5;
            
            if (direction) {
                document.getElementById('vocabQuestion').textContent = 
                    `√úbersetze ins Englische: ${currentVocab.german}`;
                currentVocab.expectedAnswer = currentVocab.english;
            } else {
                document.getElementById('vocabQuestion').textContent = 
                    `√úbersetze ins Deutsche: ${currentVocab.english}`;
                currentVocab.expectedAnswer = currentVocab.german;
            }

            document.getElementById('vocabAnswer').value = '';
            document.getElementById('vocabFeedback').innerHTML = '';
            document.getElementById('vocabAnswer').focus();
            
            updateProgress('vocab');
        }

        function nextSentenceQuestion() {
            if (gameState.currentQuestion >= gameState.totalQuestions) {
                endGame('sentence');
                return;
            }

            currentSentence = sentencesDB[Math.floor(Math.random() * sentencesDB.length)];
            document.getElementById('sentenceQuestion').textContent = 
                `Bilde den englischen Satz: ${currentSentence.german}`;

            const shuffled = [...currentSentence.words].sort(() => Math.random() - 0.5);
            const wordButtonsHTML = shuffled.map(word => 
                `<button class="word-button" onclick="selectWord('${word}')">${word}</button>`
            ).join('');

            document.getElementById('wordButtons').innerHTML = wordButtonsHTML;
            document.getElementById('selectedWords').innerHTML = '';
            document.getElementById('sentenceFeedback').innerHTML = '';
            selectedWordsArray = [];
            
            updateProgress('sentence');
        }

        function selectWord(word) {
            selectedWordsArray.push(word);
            updateSelectedWords();
        }

        function updateSelectedWords() {
            const html = selectedWordsArray.map((word, index) => 
                `<button class="word-button selected" onclick="removeWord(${index})">${word}</button>`
            ).join('');
            document.getElementById('selectedWords').innerHTML = html || 
                '<span style="color: #999;">W√§hle W√∂rter aus...</span>';
        }

        function removeWord(index) {
            selectedWordsArray.splice(index, 1);
            updateSelectedWords();
        }

        function clearSentence() {
            selectedWordsArray = [];
            updateSelectedWords();
        }

        function checkVocabAnswer() {
            const answer = document.getElementById('vocabAnswer').value.trim().toLowerCase();
            const correct = currentVocab.expectedAnswer.toLowerCase();
            
            if (answer === correct) {
                const points = 10 + (gameState.currentStreak * 2);
                showFeedback('vocabFeedback', `‚úÖ Richtig! +${points} Punkte`, true);
                gameState.currentScore += points;
                gameState.currentStreak++;
                setTimeout(() => {
                    gameState.currentQuestion++;
                    nextVocabQuestion();
                }, 1500);
            } else {
                showFeedback('vocabFeedback', 
                    `‚ùå Nicht ganz. Die richtige Antwort ist: ${currentVocab.expectedAnswer}`, false);
                gameState.currentStreak = 0;
                setTimeout(() => {
                    gameState.currentQuestion++;
                    nextVocabQuestion();
                }, 2500);
            }
        }

        function checkSentence() {
            const userSentence = selectedWordsArray.join(' ');
            const correctSentence = currentSentence.correct.join(' ');
            
            if (userSentence === correctSentence) {
                const points = 15 + (gameState.currentStreak * 3);
                showFeedback('sentenceFeedback', `‚úÖ Perfekt! +${points} Punkte`, true);
                gameState.currentScore += points;
                gameState.currentStreak++;
                setTimeout(() => {
                    gameState.currentQuestion++;
                    nextSentenceQuestion();
                }, 1500);
            } else {
                showFeedback('sentenceFeedback', 
                    `‚ùå Nicht ganz. Richtig w√§re: ${correctSentence}`, false);
                gameState.currentStreak = 0;
                setTimeout(() => {
                    gameState.currentQuestion++;
                    nextSentenceQuestion();
                }, 2500);
            }
        }

        function skipQuestion() {
            gameState.currentStreak = 0;
            gameState.currentQuestion++;
            nextVocabQuestion();
        }

        function showFeedback(elementId, message, isCorrect) {
            const feedback = document.getElementById(elementId);
            feedback.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect');
            feedback.textContent = message;
        }

        function startTimer(gameType) {
            clearInterval(gameState.timer);
            const timerElement = document.getElementById(gameType + 'Timer');
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                timerElement.textContent = `Zeit: ${gameState.timeLeft}s`;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    endGame(gameType);
                }
            }, 1000);
        }

        function updateProgress(gameType) {
            const progress = (gameState.currentQuestion / gameState.totalQuestions) * 100;
            document.getElementById(gameType + 'Progress').style.width = progress + '%';
        }

        async function endGame(gameType) {
            clearInterval(gameState.timer);
            
            userData.totalScore += gameState.currentScore;
            userData.gamesPlayed++;
            
            if (gameState.currentScore > userData.bestScore) {
                userData.bestScore = gameState.currentScore;
            }
            
            if (userData.totalScore >= userData.level * 100) {
                userData.level++;
            }
            
            await saveUserProgress();
            await loadHighscores();
            
            alert(`üéâ Spiel beendet!\n\nDeine Punkte: ${gameState.currentScore}\nSerie: ${gameState.currentStreak}\n\nGesamt-Punkte: ${userData.totalScore}\nLevel: ${userData.level}`);
            
            backToMenu();
        }

        function backToMenu() {
            clearInterval(gameState.timer);
            document.getElementById('vocabGame').classList.remove('active');
            document.getElementById('sentenceGame').classList.remove('active');
            document.getElementById('mainMenu').style.display = 'grid';
            gameState.currentQuestion = 0;
        }

        // Enter key support
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('vocabAnswer')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkVocabAnswer();
            });
            
            document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('registerPasswordConfirm')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') register();
            });
        });

        // Make functions globally available
        window.showLoginTab = showLoginTab;
        window.showRegisterTab = showRegisterTab;
        window.register = register;
        window.login = login;
        window.logout = logout;
        window.startVocabGame = startVocabGame;
        window.startSentenceGame = startSentenceGame;
        window.checkVocabAnswer = checkVocabAnswer;
        window.checkSentence = checkSentence;
        window.skipQuestion = skipQuestion;
        window.selectWord = selectWord;
        window.removeWord = removeWord;
        window.clearSentence = clearSentence;
        window.backToMenu = backToMenu;
        window.showAdminPanel = showAdminPanel;
        window.hideAdminPanel = hideAdminPanel;
        window.addVocabulary = addVocabulary;
        window.deleteVocab = deleteVocab;
        window.addSentence = addSentence;
        window.deleteSentence = deleteSentence;
        window.uploadCSV = uploadCSV;
        window.uploadPDF = uploadPDF;
        window.removePDFVocab = removePDFVocab;
        window.savePDFVocabulary = savePDFVocabulary;
        window.cancelPDFUpload = cancelPDFUpload;
        window.saveGameSettings = saveGameSettings;
        window.resetChallenge = resetChallenge;
        window.viewChallengeArchive = viewChallengeArchive;
    </script>
</body>
</html>